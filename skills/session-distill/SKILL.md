---
name: session-distill
description: "Generate or refresh CLAUDE.md by extracting recurring patterns from agent session history. Use when CLAUDE.md is absent, older than 7 days, or when an agent keeps re-explaining the same context. Do NOT use for summarizing a single session or non-agent text files."
license: MIT
compatibility: Requires Node.js 18+. Reads ~/.claude/projects/ for Claude Code, .aider.chat.history.md for Aider.
metadata:
  author: safetnsr
  version: "0.3.0"
  npm: "@safetnsr/session-distill"
  github: "https://github.com/safetnsr/session-distill"
---

# session-distill

Extract recurring patterns from agent sessions. Generate CLAUDE.md. Zero install.

## agent flow (primary)

```bash
# step 1: extract patterns + write CLAUDE.md in one call (agent mode)
npx @safetnsr/session-distill --json --out CLAUDE.md > /tmp/distill.json

# step 2: parse JSON report — filtered_patterns has confidence >= 0.6 AND sessionCount >= 2

# step 3: update memory
echo "last_distill: $(date -u +%Y-%m-%d)" >> memory/NOW.md
```

Or separately:
```bash
# extract patterns only (no file written)
npx @safetnsr/session-distill --json > /tmp/distill.json

# write CLAUDE.md only (no JSON)
npx @safetnsr/session-distill --out CLAUDE.md
```

## fallback: no sessions found

If `sessions_analyzed: 0` in JSON output, switch to file-based mode:

```bash
cat AGENTS.md SOUL.md TOOLS.md | npx @safetnsr/session-distill --from-files --json
```

### structured mode (v0.3.0+)

Parse structured markdown with known section headers for higher-confidence extraction:

```bash
cat AGENTS.md SOUL.md | npx @safetnsr/session-distill --from-files --structured --json
```

Section mapping:
- `## Rules`, `## Safety`, `## Efficiency`, `## Memory`, `## Constraints` → `explicit-instruction` (confidence 0.95)
- `## Stack`, `## Tech`, `## Dependencies` → `stack-mention` (confidence 0.8)
- `## Workflow`, `## Process`, `## How` → `convention` (confidence 0.85)
- All other sections → standard heuristic extraction

## json output schema (v0.3.0+)

```json
{
  "sessions_analyzed": 12,
  "no_sessions": false,
  "written": true,
  "path": "CLAUDE.md",
  "patterns_used": 7,
  "patterns": [
    { "text": "typescript", "sessionCount": 8, "totalSessions": 12, "confidence": 0.7, "pattern": "stack-mention" }
  ],
  "filtered_patterns": [
    { "text": "typescript", "sessionCount": 8, "totalSessions": 12, "confidence": 0.7, "pattern": "stack-mention" }
  ],
  "claude_md": "# CLAUDE.md (generated by session-distill)\n..."
}
```

When `--json` only (no `--out`): `written: false`, `path: null`.
When no sessions found: `no_sessions: true`, `sessions_analyzed: 0`, valid JSON (no error strings).

**confidence scale:**
- `0.5` — heuristic match (keyword in message)
- `0.7` — repeated across 2+ sessions
- `0.8` — structured stack section
- `0.85` — structured convention section
- `0.9` — exact repeated instruction ("always use git-ship", "never use rm")
- `0.95` — structured rules/safety section

**include rule:** only use `filtered_patterns` (confidence >= 0.6 AND sessionCount >= 2).

## heartbeat hook

Add to HEARTBEAT.md checklist:
```
- if last_distill in memory/NOW.md > 7 days ago → run session-distill --out CLAUDE.md --json
```

## flags

```bash
npx @safetnsr/session-distill --json              # JSON output only (written: false)
npx @safetnsr/session-distill --out CLAUDE.md     # write file only (text confirmation)
npx @safetnsr/session-distill --json --out CLAUDE.md  # write file + JSON report (agent mode)
npx @safetnsr/session-distill --diff              # preview changes
npx @safetnsr/session-distill --top 10            # show top patterns
npx @safetnsr/session-distill --from-files        # stdin fallback mode
npx @safetnsr/session-distill --from-files --structured  # structured markdown parsing
```

## pair with ai-ready and vibe-check

session-distill → CLAUDE.md before session starts
ai-ready → blast radius before editing files
vibe-check → audit after commit
