---
name: session-distill
description: "Generate or refresh CLAUDE.md by extracting recurring patterns from agent session history. Use when CLAUDE.md is absent, older than 7 days, or when an agent keeps re-explaining the same context. Do NOT use for summarizing a single session or non-agent text files."
license: MIT
compatibility: Requires Node.js 18+. Reads ~/.claude/projects/ for Claude Code, .aider.chat.history.md for Aider.
metadata:
  author: safetnsr
  version: "0.2.0"
  npm: "@safetnsr/session-distill"
  github: "https://github.com/safetnsr/session-distill"
---

# session-distill

Extract recurring patterns from agent sessions. Generate CLAUDE.md. Zero install.

## agent flow (primary)

```bash
# step 1: extract patterns
npx @safetnsr/session-distill --json > /tmp/distill.json

# step 2: filter — only use patterns where confidence >= 0.6 AND sessionCount >= 2
# (--json output already filtered from v0.2.0+ — field: filtered_patterns)

# step 3: write CLAUDE.md
npx @safetnsr/session-distill --out CLAUDE.md

# step 4: update memory
echo "last_distill: $(date -u +%Y-%m-%d)" >> memory/NOW.md
```

## fallback: no sessions found

If `sessions_analyzed: 0` in JSON output, switch to file-based mode:

```bash
cat AGENTS.md SOUL.md TOOLS.md | npx @safetnsr/session-distill --from-files --json
```

Same output schema. Same parse flow.

## json output schema (v0.2.0+)

```json
{
  "sessions_analyzed": 12,
  "patterns": [
    { "text": "typescript", "sessionCount": 8, "totalSessions": 12, "confidence": 0.7, "pattern": "stack-mention" }
  ],
  "filtered_patterns": [
    { "text": "typescript", "sessionCount": 8, "totalSessions": 12, "confidence": 0.7, "pattern": "stack-mention" }
  ],
  "no_sessions": false,
  "claude_md": "# CLAUDE.md (generated by session-distill)\n..."
}
```

**confidence scale:**
- `0.5` — heuristic match (keyword in message)
- `0.7` — repeated across 2+ sessions
- `0.9` — exact repeated instruction ("always use git-ship", "never use rm")

**include rule:** only use `filtered_patterns` (confidence >= 0.6 AND sessionCount >= 2).

## heartbeat hook

Add to HEARTBEAT.md checklist:
```
- if last_distill in memory/NOW.md > 7 days ago → run session-distill --out CLAUDE.md
```

## flags

```bash
npx @safetnsr/session-distill --json              # agent interface (use this)
npx @safetnsr/session-distill --out CLAUDE.md     # write to file
npx @safetnsr/session-distill --diff              # preview changes
npx @safetnsr/session-distill --top 10            # show top patterns
npx @safetnsr/session-distill --from-files        # stdin fallback mode
```

## pair with ai-ready and vibe-check

session-distill → CLAUDE.md before session starts
ai-ready → blast radius before editing files
vibe-check → audit after commit
